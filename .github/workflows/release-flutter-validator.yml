name: "Release Flutter Validator (Testnet)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Builds UAT Validator Dashboard for macOS, Linux & Windows â€” creates GitHub Release
# Triggered on merge to main (validator changes), tags, or manual dispatch
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  push:
    branches: [main]
    paths:
      - 'flutter_validator/**'
      - '.github/workflows/release-flutter-validator.yml'
    tags:
      - 'validator-v*-testnet'
      - 'validator-v*-testnet.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0-testnet)'
        required: true
        default: '1.0.0-testnet'

env:
  FLUTTER_VERSION: '3.38.4'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  macOS (.dmg)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-macos:
    name: "ğŸ macOS Validator (.dmg)"
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            flutter_validator/native/uat_crypto_ffi/target
          key: macos-validator-rust-${{ hashFiles('flutter_validator/native/uat_crypto_ffi/Cargo.lock') }}

      - name: Build Dilithium5 native library
        working-directory: flutter_validator/native/uat_crypto_ffi
        run: |
          cargo build --release
          cargo test --release -- --nocapture

      - name: Flutter pub get
        working-directory: flutter_validator
        run: flutter pub get

      - name: Flutter build macOS
        working-directory: flutter_validator
        run: flutter build macos --release

      - name: Bundle native library
        working-directory: flutter_validator
        run: |
          APP="build/macos/Build/Products/Release/flutter_validator.app"
          FRAMEWORKS="$APP/Contents/Frameworks"
          mkdir -p "$FRAMEWORKS"
          cp native/uat_crypto_ffi/target/release/libuat_crypto_ffi.dylib "$FRAMEWORKS/"
          install_name_tool -id "@executable_path/../Frameworks/libuat_crypto_ffi.dylib" "$FRAMEWORKS/libuat_crypto_ffi.dylib"
          codesign --force --deep --sign - "$APP"

      - name: Create DMG
        working-directory: flutter_validator
        run: |
          VERSION="${GITHUB_REF_NAME#validator-v}"
          [ -z "$VERSION" ] && VERSION="${{ github.event.inputs.version }}"
          if [ "$VERSION" = "$GITHUB_REF_NAME" ]; then VERSION="${{ github.event.inputs.version || '1.0.0-testnet' }}"; fi

          mkdir -p release/dmg_staging
          cp -R "build/macos/Build/Products/Release/flutter_validator.app" release/dmg_staging/
          ln -s /Applications release/dmg_staging/Applications

          cat > release/dmg_staging/README.txt << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         UAT VALIDATOR DASHBOARD - TESTNET RELEASE          â•‘
          â•‘                Unauthority Blockchain                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          INSTALLATION:
            Drag "flutter_validator.app" to the Applications folder.

          FIRST RUN:
            1. Open the app from Applications
            2. If blocked: System Settings â†’ Privacy â†’ Open Anyway
            3. The dashboard auto-configures Tor + Dilithium5 crypto
          EOF

          hdiutil create \
            -volname "UAT Validator" \
            -srcfolder release/dmg_staging \
            -ov -format UDZO \
            "release/UAT-Validator-${VERSION}-macos.dmg"

          rm -rf release/dmg_staging

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: validator-macos
          path: flutter_validator/release/*.dmg
          if-no-files-found: error

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Linux (.tar.gz)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    name: "ğŸ§ Linux Validator (.tar.gz)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake git ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libsecret-1-dev libjsoncpp-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            flutter_validator/native/uat_crypto_ffi/target
          key: linux-validator-rust-${{ hashFiles('flutter_validator/native/uat_crypto_ffi/Cargo.lock') }}

      - name: Build Dilithium5 native library
        working-directory: flutter_validator/native/uat_crypto_ffi
        run: |
          cargo build --release
          cargo test --release -- --nocapture

      - name: Flutter pub get
        working-directory: flutter_validator
        run: flutter pub get

      - name: Flutter build Linux
        working-directory: flutter_validator
        run: flutter build linux --release

      - name: Bundle native library & package
        working-directory: flutter_validator
        run: |
          VERSION="${GITHUB_REF_NAME#validator-v}"
          [ -z "$VERSION" ] && VERSION="${{ github.event.inputs.version }}"
          if [ "$VERSION" = "$GITHUB_REF_NAME" ]; then VERSION="${{ github.event.inputs.version || '1.0.0-testnet' }}"; fi

          BUNDLE="build/linux/x64/release/bundle"

          cp native/uat_crypto_ffi/target/release/libuat_crypto_ffi.so "$BUNDLE/lib/"

          cat > "$BUNDLE/run.sh" << 'LAUNCHER'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
          exec "${SCRIPT_DIR}/flutter_validator" "$@"
          LAUNCHER
          chmod +x "$BUNDLE/run.sh"

          cat > "$BUNDLE/README.txt" << 'EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            UAT VALIDATOR DASHBOARD - TESTNET RELEASE (Linux)
            Unauthority Blockchain
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          INSTALLATION:
            1. Extract this archive
            2. Run: ./run.sh

          The validator dashboard connects to your UAT node.
          EOF

          mkdir -p release
          cd build/linux/x64/release
          tar czf "../../../../release/UAT-Validator-${VERSION}-linux-x64.tar.gz" bundle/
          cd ../../../../

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: validator-linux
          path: flutter_validator/release/*.tar.gz
          if-no-files-found: error

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Windows (.zip)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    name: "ğŸªŸ Windows Validator (.zip)"
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            flutter_validator/native/uat_crypto_ffi/target
          key: windows-validator-rust-${{ hashFiles('flutter_validator/native/uat_crypto_ffi/Cargo.lock') }}

      - name: Build Dilithium5 native library
        working-directory: flutter_validator/native/uat_crypto_ffi
        run: |
          cargo build --release
          cargo test --release -- --nocapture

      - name: Flutter pub get
        working-directory: flutter_validator
        run: flutter pub get

      - name: Flutter build Windows
        working-directory: flutter_validator
        run: flutter build windows --release

      - name: Bundle native library & package
        working-directory: flutter_validator
        shell: pwsh
        run: |
          $version = "$env:GITHUB_REF_NAME" -replace '^validator-v',''
          if (-not $version -or $version -eq $env:GITHUB_REF_NAME) { $version = "${{ github.event.inputs.version || '1.0.0-testnet' }}" }

          $bundle = "build\windows\x64\runner\Release"

          Copy-Item "native\uat_crypto_ffi\target\release\uat_crypto_ffi.dll" "$bundle\"

          @"
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            UAT VALIDATOR DASHBOARD - TESTNET RELEASE (Windows)
            Unauthority Blockchain
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          INSTALLATION:
            1. Extract this archive
            2. Run: flutter_validator.exe

          The validator dashboard connects to your UAT node.
          "@ | Out-File -FilePath "$bundle\README.txt" -Encoding utf8

          New-Item -ItemType Directory -Force -Path release | Out-Null
          Compress-Archive -Path "$bundle\*" -DestinationPath "release\UAT-Validator-${version}-windows-x64.zip" -Force

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: validator-windows
          path: flutter_validator/release/*.zip
          if-no-files-found: error

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Create GitHub Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: "ğŸ“¦ Create Validator Release"
    needs: [build-macos, build-linux, build-windows]
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="validator-v${VERSION}"
          elif [[ "${GITHUB_REF_NAME}" == validator-v* ]]; then
            TAG="${GITHUB_REF_NAME}"
            VERSION="${TAG#validator-v}"
          else
            # Push to main (no tag) â€” use default version
            VERSION="1.0.0-testnet"
            TAG="validator-v${VERSION}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "UAT Validator ${{ steps.version.outputs.version }} (Testnet)"
          draft: false
          prerelease: true
          generate_release_notes: true
          body: |
            # ğŸ–¥ï¸ UAT Validator Dashboard â€” Testnet Release `${{ steps.version.outputs.version }}`

            **Post-Quantum Secure** validator monitoring dashboard for the Unauthority blockchain testnet.

            ## ğŸ“¥ Downloads

            | Platform | File | Install |
            |----------|------|---------|
            | ğŸ **macOS** | `UAT-Validator-*-macos.dmg` | Open DMG â†’ drag to Applications |
            | ğŸ§ **Linux** | `UAT-Validator-*-linux-x64.tar.gz` | Extract â†’ `./run.sh` |
            | ğŸªŸ **Windows** | `UAT-Validator-*-windows-x64.zip` | Extract â†’ `flutter_validator.exe` |

            ## âœ… What's Included

            - ğŸ” **CRYSTALS-Dilithium5** â€” Post-quantum digital signatures
            - ğŸ§… **Automatic Tor** â€” Zero-config .onion connectivity
            - ğŸ“Š **Live Dashboard** â€” Validator stats, peers, blocks, uptime
            - ğŸ›¡ï¸ **Slashing Monitor** â€” Track validator penalties
            - ğŸ”‘ **Key Management** â€” Generate/import validator keys with BIP39 seed phrases
            - âš¡ **aBFT Consensus** â€” Real-time consensus status and finality tracking

            ## ğŸš€ First Run

            1. Install & open the validator dashboard
            2. Import existing keys or generate new ones
            3. Configure your node endpoint (localhost or .onion)
            4. Dashboard connects automatically via Tor

            ## âš ï¸ Notes

            - This is a **testnet** release â€” tokens have no real value
            - Requires a running UAT node (see [Testnet Guide](https://github.com/unauthoritymky-6236/unauthority-core/blob/main/docs/TESTNET_OPERATION.md))
            - Minimum 1,000 UAT stake for validator participation

          files: |
            artifacts/validator-macos/*.dmg
            artifacts/validator-linux/*.tar.gz
            artifacts/validator-windows/*.zip
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
